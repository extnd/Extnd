<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Extnd-data-proxy-Ajax'>/**
</span> * Custom version of the Ext.data.proxy.Ajax to work better with Domino views
 */
Ext.define('Extnd.data.proxy.Ajax', {

    extend  : 'Ext.data.proxy.Ajax',
    alias   : 'proxy.xnd-ajax',

    alternateClassName: 'Extnd.data.AjaxProxy',

    requires: [
        'Extnd.data.ViewXmlReader'
    ],

<span id='Extnd-data-proxy-Ajax-cfg-startParam'>    // remap paramNames to work with Domino views
</span>    startParam  : 'start',
<span id='Extnd-data-proxy-Ajax-cfg-sortParam'><span id='Extnd-data-proxy-Ajax-cfg-limitParam'>    limitParam  : 'count',  // domino uses count
</span></span>    sortParam   : '',       // the getParams override adds the domino specific sort params

<span id='Extnd-data-proxy-Ajax-property-sortAscParam'>    // the Domino specific sort params
</span>    sortAscParam    : 'resortascending',
<span id='Extnd-data-proxy-Ajax-property-sortDescParam'>    sortDescParam   : 'resortdescending',
</span>
<span id='Extnd-data-proxy-Ajax-method-constructor'>    constructor: function (config) {
</span>        var me = this;

        Ext.apply(me, {
            reader: {
                type            : 'xnd-viewxml',
                root            : 'viewentries',
                record          : 'viewentry',
                totalProperty   : '@toplevelentries'
            }
        });

        me.callParent(arguments);
    },

<span id='Extnd-data-proxy-Ajax-method-getParams'>    /**
</span>     * @override
     * Custom version for Domino that sets up the remote sorting param correctly
     */
    getParams: function (operation) {
        var me = this,
            params = {},
            sorters = operation.sorters,
            field,
            sortColumn;

        // get the params the way ExtJS would do them
        params = me.callParent(arguments);

        // Now we can modify the sort param the way Domino expects it
        // Domino does not have separate params for sort and dir
        // instead, domino combines them into one of two choices
        // resortascending=colNbr
        // resortdescending=colNbr

        if (sorters &amp;&amp; sorters.length &gt; 0) {

            field = me.getReader().model.prototype.fields.get(sorters[0].property);
            sortColumn = field.column;

            switch (sorters[0].direction) {
            case &quot;ASC&quot;:
                me.setDominoSortParam(params, me.sortAscParam, sortColumn);
                break;
            case &quot;DESC&quot;:
                me.setDominoSortParam(params, me.sortDescParam, sortColumn);
                break;
            case &quot;RESTORE&quot;:
                delete params.start;
                delete params.startkey;
                delete params[me.sortAscParam];
                delete params[me.sortDescParam];
                break;
            }
        }

        return params;
    },

<span id='Extnd-data-proxy-Ajax-method-setDominoSortParam'>    /**
</span>     * Given a domino specific sort param (ie 'resortascending' or 'resortdescending' then this method makes
     * sure that all other dependent params are set up correctly
     * @param {String} sortParam The domino sort param to set
     * @param {Number} sortColumn The column to sort on
     * @return {Object} The update params object
     */
    setDominoSortParam: function (params, sortParam, sortColumn) {
        var me = this;

        if (params[sortParam] !== undefined) {

            if (params[sortParam] !== sortColumn) {
                // changing to a new sort column, so reset the column
                params[sortParam] = sortColumn;

                if (params.start) {
                    // if there was a start param before we delete both the start and startkey params
                    // however, NOTE: that we don't check for a startkey since it is valid for a user
                    // to have a startkey and then do a sort
                    delete params.start;
                    delete params.startkey;
                }

            } else {
                if (params.start) {
                    delete params.startkey; // delete startkey once we have a start param
                }
            }

        } else {

            params[sortParam] = sortColumn;
            // since this is the first time sorting in this direction for this column
            // we need to delete these params so that we do things the way Domino expects it
            delete params.start;
            delete params.startkey;
        }

        // always make sure we delete the opposite sort param since Domino doesn't like seeing both
        if (sortParam === me.sortAscParam) {
            delete params[me.sortDescParam];
        } else {
            delete params[me.sortAscParam];
        }


        return params;

    }

});
</pre>
</body>
</html>
