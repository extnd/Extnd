<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Extnd-grid-Panel'>/**
</span> * Customized grid to work with Domino views.  All of the work to define the columns and the underlying store, model, proxy, etc.
 * is handled for you.
 * The minimum config needed is the viewUrl or the dbPath and viewName.  Based on this information, a call to ?ReadDesign
 * is made and a Model is then dynamically created for you based on the design of the Domino View.

    @example
    Ext.create('Extnd.UIView', {
        title       : 'Flat View Example',
        dbPath      : '/extnd/demo.nsf/',
        viewName    : 'f1',
        width       : 400,
        height      : 500,
        renderTo    : Ext.getBody()
    });


 * {@img Extnd.UIView.png Flat View Example}
 *
 */
Ext.define('Extnd.grid.Panel', {

    extend: 'Ext.grid.Panel',

    alias: [
        'widget.xnd-uiview',
        'widget.xnd-gridpanel',
        'widget.xnd-grid'
    ],

    alternateClassName: [
        'Extnd.UIView',
        'Ext.nd.UIView',
        'Ext.nd.GridPanel'
    ],

    requires: [
        'Extnd.data.ViewDesign',
        'Extnd.toolbar.Paging',
        'Extnd.toolbar.Actionbar'
    ],

<span id='Extnd-grid-Panel-cfg-viewType'>    viewType                : 'gridview',
</span><span id='Extnd-grid-Panel-property-renderers'>    renderers               : [],
</span><span id='Extnd-grid-Panel-property-quickSearchKeyStrokes'>    quickSearchKeyStrokes   : [],
</span><span id='Extnd-grid-Panel-property-targetDefaults'>    targetDefaults          : {},
</span><span id='Extnd-grid-Panel-property-tbarPlugins'>    tbarPlugins             : [],
</span><span id='Extnd-grid-Panel-property-bbarPlugins'>    bbarPlugins             : [],
</span><span id='Extnd-grid-Panel-property-colsFromDesign'>    colsFromDesign          : [],
</span><span id='Extnd-grid-Panel-property-extraParams'>    extraParams             : {},
</span>

<span id='Extnd-grid-Panel-property-showActionbar'>    showActionbar                   : true,
</span><span id='Extnd-grid-Panel-property-showPagingToolbar'>    showPagingToolbar               : true,
</span><span id='Extnd-grid-Panel-property-showSearch'>    showSearch                      : true,
</span><span id='Extnd-grid-Panel-property-showSearchPosition'>    showSearchPosition              : 'bottom',
</span><span id='Extnd-grid-Panel-property-showCategoryComboBox'>    showCategoryComboBox            : false,
</span><span id='Extnd-grid-Panel-property-showCategoryComboBoxPosition'>    showCategoryComboBoxPosition    : 'top',
</span><span id='Extnd-grid-Panel-property-buildActionBarFromDXL'>    buildActionBarFromDXL           : true,
</span><span id='Extnd-grid-Panel-property-editMode'>    editMode                        : true,
</span><span id='Extnd-grid-Panel-property-multiExpand'>    multiExpand                     : false,
</span><span id='Extnd-grid-Panel-property-multiExpandCount'>    multiExpandCount                : 40,
</span><span id='Extnd-grid-Panel-property-notCategorizedText'>    notCategorizedText              : '(Not Categorized)',
</span><span id='Extnd-grid-Panel-property-loadInitialData'>    loadInitialData                 : true,
</span><span id='Extnd-grid-Panel-cfg-layout'>    layout                          : 'fit',
</span>
<span id='Extnd-grid-Panel-property-documentWindowTitle'>    documentWindowTitle             : '',
</span><span id='Extnd-grid-Panel-property-documentLoadingWindowTitle'>    documentLoadingWindowTitle      : 'Opening...',
</span><span id='Extnd-grid-Panel-property-documentUntitledWindowTitle'>    documentUntitledWindowTitle     : '(Untitled)',
</span><span id='Extnd-grid-Panel-property-documentWindowTitleMaxLength'>    documentWindowTitleMaxLength    : 16,
</span><span id='Extnd-grid-Panel-property-useDocumentWindowTitle'>    useDocumentWindowTitle          : true,
</span>
<span id='Extnd-grid-Panel-property-extendLastColumn'>    extendLastColumn                : undefined,
</span><span id='Extnd-grid-Panel-property-enableDragDrop'>    enableDragDrop                  : true,
</span><span id='Extnd-grid-Panel-property-ddGroup'>    ddGroup                         : 'TreeDD',
</span><span id='Extnd-grid-Panel-property-loadMask'>    loadMask                        : true,
</span>

<span id='Extnd-grid-Panel-property-noteType'>    // private
</span>    noteType                        : 'view',

<span id='Extnd-grid-Panel-property-count'>    count: 40,
</span><span id='Extnd-grid-Panel-property-storeConfig'>    storeConfig: {
</span>        pageSize: 40
    },

<span id='Extnd-grid-Panel-cfg-viewConfig'>    viewConfig: {},
</span>
<span id='Extnd-grid-Panel-property-isCategorized'>    isCategorized   : false,
</span><span id='Extnd-grid-Panel-property-needsColumns'>    needsColumns    : true,
</span><span id='Extnd-grid-Panel-property-needsFields'>    needsFields     : true,
</span>
<span id='Extnd-grid-Panel-property-selModelConfig'>    // TODO ExtJS4 uses selModel that can be a config or a selection model instance
</span>    selModelConfig: {
        singleSelect : false,
        checkOnly : true
    },

<span id='Extnd-grid-Panel-property-quickSearchConfig'>    quickSearchConfig: {
</span>        width: 200
    },



<span id='Extnd-grid-Panel-method-initComponent'>    initComponent: function () {
</span>        var me = this;

        // applyIf so that these can all be overridden if passed into the config
        Ext.applyIf(me, {
            store               : me.createStore(),
            collapseIcon        : Extnd.extndUrl + 'resources/images/minus.gif',
            expandIcon          : Extnd.extndUrl + 'resources/images/plus.gif',
            dateTimeFormats     : Extnd.dateTimeFormats,
            formatCurrencyFnc   : Ext.util.Format.usMoney,
            columns             : me.getInitialColumns(),
            bbar                : me.getBottomBarCfg()
        });

        me.setupToolbars();
        me.callParent(arguments);
    },


<span id='Extnd-grid-Panel-method-getInitialColumns'>    getInitialColumns: function () {
</span>        var me = this,
            returnVal;

        if (me.columns) {
            me.needsColumns = false;
        } else {
            returnVal = [
                {
                    dataIndex   : 'dummy',
                    header      : '&amp;nbsp;',
                    flex        : 1
                }
            ];
        }

        return returnVal;

    },

<span id='Extnd-grid-Panel-method-createStore'>    createStore: function () {
</span>        var me = this,
            store;

        // only create a dummy store if one was not provided
        // in the callback from fetching the design info, we'll create a new store and do a reconfigure
        if (!me.store) {

            me.needsFields = true;
            me.dmyId = 'xnd-dummy-store-' + Ext.id();

            store = Ext.create('Ext.data.Store', {
                id: me.dmyId,
                fields: ['dummy']
            });
        }

        return store;

    },


<span id='Extnd-grid-Panel-method-onRender'>    onRender: function () {
</span>        var me = this;

        me.callParent(arguments);

        if (me.needsColumns) {
            me.getViewDesign();

        } else {
            if (me.showPagingToolbar) {
                me.updatePagingToolbar();
            }

            me.store.load({
                params: {
                    count: me.count,
                    start: 1
                }
            });

            me.fireEvent('open', me);
        }

    },


<span id='Extnd-grid-Panel-method-getViewDesign'>    getViewDesign: function () {
</span>        var me = this;

        me.viewDesign = Ext.create('Ext.nd.data.ViewDesign', {
            dbPath              : me.dbPath,
            viewName            : me.viewName,
            category            : me.category,
            multiExpand         : me.multiExpand,
            storeConfig         : me.storeConfig,
            extraParams         : me.extraParams,
            removeCategoryTotal : false,
            callback            : me.getViewDesignCB,
            scope               : me
        });

    },

<span id='Extnd-grid-Panel-method-getViewDesignCB'>    // private
</span>    getViewDesignCB: function (o) {
        var me = this,
            pg,
            col,
            len,
            i;

        // get the properties we need
        me.store = me.viewDesign.store;
        me.isCategorized = me.viewDesign.dominoView.meta.isCategorized;
        me.isCalendar = me.viewDesign.dominoView.meta.isCalendar;
        me.allowDocSelection = me.viewDesign.allowDocSelection;
        me.autoExpandColumn = me.viewDesign.autoExpandColumn;
        me.isView = me.viewDesign.isView;
        me.isFolder = me.viewDesign.isFolder;


        /* if the view is set to allow for docs to be selected with checkbox AND
         * the developer has not explicitly set me.selModelConfig.type
         * to something OTHER than 'checkbox' then change the selModel to the
         * CheckboxSelectionModel and push that onto the colsFromDesign array
         */

        // don't do this if type was explicitly set to something else
        if (me.allowDocSelection &amp;&amp; me.selModelConfig.type !== 'checkbox') {

            // remove the grid's current rowclick event if it is using
            // our custom handleDDRowClick override
            // TODO
            //me.un('rowclick', me.selModel.handleDDRowClick, me.selModel);

            // now destroy the old selModel
            // TODO do we need this since it appears that destroy is just an emptyFn call
//                if (me.selModel &amp;&amp; me.selModel.destroy){
//                    me.selModel.destroy();
//                }

            // add in the new selection model
            //me.selModel = new Ext.selection.CheckboxModel(me.selModelConfig);

            // call the init manually (you are not supposed to do this since the grid
            // does this automatically, but since we are changing the selModel on the
            // fly, we need to do this now)
            // TODO don't think we need this now since calling me.reconfigure later on handles selModel
            //me.selModel.init(me);

            /*
             * this function is a copy/paste from the CheckboxSelectionModel
             * and what it does it make sure that we have mousedown events
             * defined to capture clicking on the checkboxes
             */
             // TODO do we need this?  if so, need to fix the errors it throws
//                me.on('getdesignsuccess', function(){
//                    var view = me.grid.getView();
//                    view.mainBody.on('mousedown', me.onMouseDown, me);
//                    Ext.fly(view.innerHd).on('mousedown', me.onHdMouseDown, me);
//                }, me.selModel);


            me.colsFromDesign.length = 0; // make sure nothing is in our colsFromDesign array
            // TODO looks like we don't need this since ExtJS 4 takes care of adding a checkbox column if needed
            //me.colsFromDesign.push(me.selModel);
        }


        // add our columns from the viewDesign call and dominoRenderer or any custom renderers if defined
        // TODO add back support for developer defined custom renderers
        len = me.viewDesign.columns.items.length;
        for (i = 0; i &lt; len; i++) {
            //var rendr = (me.renderers[i]) ? me.renderers[i] : Ext.bind(me.dominoRenderer, me);
            col = me.viewDesign.columns.items[i];
            //col.renderer = rendr;
            me.colsFromDesign.push(col);
        }


        if (me.isCategorized &amp;&amp; me.multiExpand) {
            //me.selModel = new Ext.nd.CategorizedRowSelectionModel();
            //console.log(['categorized', me]);
            me.view = new Extnd.CategorizedView({});
            me.enableColumnMove = false;
            me.view.init(me);
            me.view.render();
        } else {
            // the grid cellclick will allow us to capture clicking on an
            // expand/collapse icon for the classic domino way
            // but only do this if 'multiExpand' is set to false
            me.on('cellclick', me.gridHandleCellClick, me, true);
        }


        // make sure me.view is set, otherwise the reconfigure call will fail
        if (!me.view) {
            me.view = me.getView();
        }

        // need to reconfigure the grid to now use the store and colsFromDesign built
        // from our Ajax call to the Domino server since we used a 'dummy'
        // store and column to begin with
        me.reconfigure(me.store, me.colsFromDesign);

        /* There may be cases where a grid needs to be rendered the firs time
         * without any data. A good example is a view where you want to show
         * the user the SingleCategoryCombo of choices but don't want to do an
         * initial load of the data and instead, wait until the user makes a
         * choice.
         */
        // TODO: is this really needed? Stores already have an autoLoad property that we can use
        if (me.loadInitialData) {
            me.store.load({
                params: {
                    count: me.count,
                    start: 1
                }
            });
        }

        if (me.showPagingToolbar) {
            me.updatePagingToolbar();
        }

        // update me.documents property when a row is selected/deselected
        // TODO
//        me.selModel.on('rowselect', function(sm, rowIndex, rec){
//            me.documents = me.getDocuments();
//        }, me);
//        me.selModel.on('rowdeselect', function(){
//            me.documents = me.getDocuments();
//        }, me);


        me.fireEvent('getdesignsuccess', me);
        me.fireEvent('open', me);
    },

<span id='Extnd-grid-Panel-method-updatePagingToolbar'>    updatePagingToolbar: function () {
</span>        var me = this,
            pg = me.down('xnd-pagingtoolbar');

        // now that we know if the view is categorized or not we need to let
        // the paging toolbar know
        if (pg) {
            pg.isCategorized = me.isCategorized;
            pg.bindStore(null);
            pg.bindStore(me.store);
            pg.updateInfo();
        }
    },

<span id='Extnd-grid-Panel-method-gridHandleCellClick'>    /**
</span>     * Custom #cellclick handler to handle expand/collapse of categories and responses
     */
    gridHandleCellClick: function (grid, td, colIndex, record, tr, rowIndex, e) {
        var me          = this,
            ecImg       = Ext.get(e.getTarget()),
            cell        = false,
            newParams   = {},
            store       = grid.getStore(),
            lastCount   = store.lastOptions.params.count || me.count,
            cellCat,
            cellResponse,
            cellEl,
            isExpand,
            isCollapse;

        // since we add IMG tags for the expand/collapse icon we only check for this and ignore all other clicks
        if (ecImg.dom.tagName === 'IMG') {
            cellCat = ecImg.findParent('td.xnd-view-category');
            cell = cellCat;

            if (!cellCat) {
                cellResponse = ecImg.findParent('td.xnd-view-response');
                cell = cellResponse;
            }

            if (cell) {

                cellEl = Ext.get(cell);
                isExpand = cellEl.hasCls('xnd-view-expand');

                if (isExpand) {

                    // need to expand (count is determined by taking the
                    // rowIndex and adding this.count, unless lastCount
                    // is -1 and in that case just use it)
                    newParams = {
                        count: ((lastCount !== undefined) &amp;&amp; lastCount !== -1) ? rowIndex + me.count : lastCount,
                        expand: record.position
                    };
                    /*
                     * since we are loading the entire store, we do not need the remove/addClass methods
                     * add this back when we just remove/add to the grid the data for the category
                     * cellEl.removeClass('xnd-view-expand');
                     * cellEl.addClass('xnd-view-collapse');
                     */
                    store.load({params : newParams});

                } else {

                    isCollapse = cellEl.hasCls('xnd-view-collapse');

                    if (isCollapse) {

                        // need to collapse (count is determined by the lastOptions.params.count)
                        newParams = {
                            count: (lastCount !== undefined) ? lastCount : me.count,
                            collapse: record.position
                        };
                        /*
                         * since we are loading the entire store, we do not need the remove/addClass methods
                         * add this back when we just remove/add to the grid the data for the category
                         * cellEl.removeClass('xnd-view-collapse');
                         * cellEl.addClass('xnd-view-expand');
                         */
                        store.load({params : newParams});

                    }
                }
            }
        }
    },

<span id='Extnd-grid-Panel-method-getPlugins'>    getPlugins : function(){
</span>
        // category combo plugin
        if (this.showCategoryComboBox) {
            var cp = new Ext.nd.SingleCategoryCombo({
                viewUrl: this.viewUrl,
                value: this.category,
                count: this.categoryComboBoxCount || -1
            });
            // make sure category has some value
            if (typeof this.category == 'undefined') {
                this.category = '';
            }
            if (this.showCategoryComboBoxPosition == 'top') {
                this.tbarPlugins.push(cp);
            } else {
                this.bbarPlugins.push(cp);
            }
        } // eo showCategoryComboBox plugin


        // search plugin
        if (this.showSearch) {
            console.log('TODO add back search plugin support');
//            var sp = new Ext.nd.SearchPlugin(this)
//            if (this.showSearchPosition == 'top') {
//                this.tbarPlugins.push(sp)
//            } else {
//                this.bbarPlugins.push(sp)
//            }
        }

    },

<span id='Extnd-grid-Panel-method-setupToolbars'>    // private
</span>    setupToolbars : function() {

        // the actionbar/toolbar plugins
        this.getPlugins();

        var tbId = 'xnd-view-toolbar-' + Ext.id();

        // if a tbar was passed in, just use that and add the plugins to it
        if (this.tbar) {
            if (Ext.isArray(this.tbar)) {
                this.tbar = new Ext.nd.Actionbar({
                    id: tbId,
                    noteName: '',
                    uiView: this,
                    target: this.getTarget() || null,
                    items: this.tbar,
                    plugins: this.tbarPlugins
                });
            }
            else {
                if (this.tbar.add) {
                    this.tbar.add(this.tbarPlugins);
                }
                this.tbar.uiView = this;
                this.tbar.id = tbId;
            }
        } else {
            if (this.showActionbar) {
                this.tbar = new Extnd.toolbar.Actionbar({
                    id: tbId,
                    noteType: this.noteType,
                    dbPath: this.dbPath,
                    noteName: this.viewName,
                    uiView: this,
                    useDxl: this.buildActionBarFromDXL,
                    useViewTitleFromDxl: this.useViewTitleFromDxl,
                    removeEmptyActionbar: this.removeEmptyActionbar,
                    target: this.getTarget() || null,
                    plugins: this.tbarPlugins
                });
            } else {
                // if plugins are wanted but not the actionbar then create an Ext.nd.Actionbar
                // anyway but don't pass in a noteName so that the actions will not be created
                // and then add the plugins to it
                if (this.tbarPlugins.length &gt; 0) {
                    this.tbar = new Ext.nd.Actionbar({
                        id: tbId,
                        noteName: '', //intentional
                        uiView: this,
                        target: this.getTarget() || null,
                        plugins: this.tbarPlugins
                    });
                }
            }
        }
    },

<span id='Extnd-grid-Panel-method-getTarget'>    // private
</span>    // TODO should we support this or should developers add their own listeners to handle opening of documents
    getTarget : function() {
        if (this.target) {
            return this.target;
        } else {
            // if a target property is available then set it
            if (window &amp;&amp; window.target) {
                this.target = window.target;
                return this.target;
            } else {
                // for an uiview or uidoc you need to go a level
                if (this.ownerCt &amp;&amp; this.ownerCt.getXType &amp;&amp; this.ownerCt.getXType() == 'tabpanel') {
                    this.target = this.ownerCt.id;
                    return this.target;
                } else {
                    return null;
                }
            }
        }
    },

<span id='Extnd-grid-Panel-method-getBottomBarCfg'>    getBottomBarCfg: function () {
</span>        var me = this;

        if (me.showPagingToolbar) {
            return {
                xtype       : 'xnd-pagingtoolbar',
                displayInfo : true,
                store       : me.store
            };
        }
    }

});
</pre>
</body>
</html>
