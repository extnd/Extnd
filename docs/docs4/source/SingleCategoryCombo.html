<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js"><span id='Extnd-toolbar-plugin-SingleCategoryCombo'>/**
</span> * Plugin that adds a combo to a toolbar on an Extnd.UIView.  The UIView view must be a categorized view which is
 * able to have the viewable data restricted to just the contents of a single category.
 */
Ext.define('Extnd.toolbar.plugin.SingleCategoryCombo', {

    extend  : 'Ext.AbstractPlugin',
    alias   : 'plugin.xnd-view-singlecategorycombo',

    mixins: {
        observable: 'Ext.util.Observable'
    },

<span id='Extnd-toolbar-plugin-SingleCategoryCombo-property-count'>    count   : -1,
</span><span id='Extnd-toolbar-plugin-SingleCategoryCombo-property-value'>    value   : '',
</span><span id='Extnd-toolbar-plugin-SingleCategoryCombo-property-viewUrl'>    viewUrl : '',
</span>
<span id='Extnd-toolbar-plugin-SingleCategoryCombo-property-categoryComboBoxEmptyText'>    categoryComboBoxEmptyText: 'Select a category...',
</span>
<span id='Extnd-toolbar-plugin-SingleCategoryCombo-method-constructor'>    constructor: function (config) {
</span>        var me = this;

        me.addEvents(
<span id='Extnd-toolbar-plugin-SingleCategoryCombo-event-beforeedit'>            /**
</span>             * @event beforeedit
             * Fires when a category is changed.
             */
            'categorychange'
        );

        me.callParent(arguments);
        me.mixins.observable.constructor.call(me);

    },

<span id='Extnd-toolbar-plugin-SingleCategoryCombo-method-init'>    init: function (toolbar) {
</span>        var model;

        this.toolbar = toolbar;

        // if the parent toolbar is an Ext.nd.Actionbar
        // then we need to wait to add the actions
        // until the parent is done with adding its actions

        if (this.toolbar.isXType('xnd-actionbar', true)) {
            this.toolbar.on('actionsloaded', this.createCombo, this);
        } else {
            this.toolbar.on('render', this.createCombo, this);
        }


        // setup a default way to handle a category change
        this.on('categorychange', this.onCategoryChange, this);

        // now apply any custom listeners
        if (this.listeners) {
            this.on(this.listeners);
            delete this.listeners;
        }

        // define a model to use
        model = Ext.define('Extnd.data.model.SingleCategory-' + Ext.id(), {
            extend: 'Extnd.data.ViewModel',
            fields: [
                {
                    name    : 'category',
                    mapping : 'entrydata[category=true]',
                    type    : 'string'
                }
            ]
        });

        // setup the ViewStore
        this.store = Ext.create('Extnd.data.ViewStore', {
            model   : model,
            viewUrl : this.toolbar.getUIView().viewUrl
        });

        // load it collapsed to get the categories
        this.store.load({
            params: {
                collapseview    : true,
                count           : this.count
            }
        });

    },

<span id='Extnd-toolbar-plugin-SingleCategoryCombo-method-createCombo'>    // private
</span>    createCombo: function () {
        var cmbId = 'xnd-search-combo-' + Ext.id();
        this.combo = this.toolbar.add({
            xtype           : 'combo',
            //id              : cmbId,
            store           : this.store,
            displayField    : 'category',
            typeAhead       : true,
            queryMode       : 'local',
            triggerAction   : 'all',
            emptyText       : this.categoryComboBoxEmptyText,
            value           : this.value,
            width           : 120,
            selectOnFocus   : true,
            grow            : true,
            listeners: {
                change  : this.onCategoryChange,
                scope   : this
            }
        });

    },

<span id='Extnd-toolbar-plugin-SingleCategoryCombo-method-onComboSelect'>    onComboSelect: function (combo, record, index) {
</span>        this.fireEvent('categorychange', combo, record, index);
    },

<span id='Extnd-toolbar-plugin-SingleCategoryCombo-method-onCategoryChange'>    // private
</span>    onCategoryChange: function (combo, newVal, oldVal) {
        var uiview = this.toolbar.getUIView(),
            store = uiview.getStore();

        store.extraParams.RestrictToCategory = newVal;
        store.load({params: {start: 1}});
    }

});
</pre>
</body>
</html>
